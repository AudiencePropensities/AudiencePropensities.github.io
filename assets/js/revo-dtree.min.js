/*! revo-dtree 2013-10-19 */
!function(a,b,c){"undefined"!=typeof module&&module.exports?module.exports=c():"function"==typeof define&&define.amd?define(c):b[a]=c()}("dtree",this,function(){function a(b){this.options=b,a.palette=b.palette||a.palette,this.render();var c=r.select("#legend-toggle");c.on("click",function(){var a="-"===c.html();c.html(a?"+":"-");var b=r.select("#dep-legend");b.style("display",a?"none":"block")})}function b(){var a=C.labelLength,b=r.select("#body").selectAll(".tree-label")[0];b.forEach(function(b){b.textContent=b.innerHTML=j(b.getAttribute("text-orig"),a)})}function c(b,c){function e(a){a&&a.children&&(a.children.forEach(e),f(a))}t=r.scale.linear(),u=r.scale.linear(),v=r.layout.tree().size([L,K]),w=r.svg.diagonal().projection(function(a){return[a.x,a.y]}),x=r.select("#body").append("svg:svg").attr("id","tree").attr("width",K+J[1]+J[3]).attr("height",L+J[0]+J[2]+1e3).append("svg:g").attr("transform","translate(0,"+J[0]+")"),y=r.scale.linear(),z=r.scale.category10(),s=b,s.x0=0,s.y0=0,R=k(s),y=r.scale.linear().domain([s.summary.minn,s.n]).range([Q,P]);var g=c?c.range:a.palette.range;if("class"===s.method){var h=s.legend.depVars.levels.length-1;u=r.scale.linear().domain([s.summary.minloss,s.summary.maxloss]).range([S,T]),t=r.scale.linear().domain([0,h]).range(g)}else u=r.scale.linear().domain([s.summary.mindev,s.summary.maxdev]).range([S,T]),t=r.scale.linear().domain([s.legend.depVars.minyval,s.legend.depVars.maxyval]).range(g);A=new a({palette:c,method:s.method,rule:{depVars:s.legend.depVars,indVars:s.legend.indVars}}).channels(),s.children.forEach(e),d(s)}function d(a){e(a);var b=500,c=v.nodes(s).reverse();c.forEach(function(a){a.y=90*a.depth});var k=x.selectAll("g.node").data(c,function(a){return a.id||(a.id=++M)}),n=k.enter().append("svg:g").attr("class","node").attr("transform",function(){return"translate("+a.x0+","+a.y0+")"}).on("click",function(a){"leaf"!==a.type&&(B=!0,setTimeout(function(){B=!1,e(a)},580),r.event&&r.event.altKey?(l(a),m(a)):r.event&&(r.event.ctrlKey||r.event.metaKey)?(l(a),f(a)):f(a),d(a))}).call(r.helper.tooltip(s.method).text(function(a){return a}));n.append("svg:rect").attr("class","tree-node").attr("y",-1).attr("x",function(){var a=r.max([N,N]);return-a/2}).attr("width",1e-6).attr("height",1e-6).attr("rx",function(a){return"split"===a.type?20:2}).attr("ry",function(a){return"split"===a.type?20:2}).style("stroke",function(){return"#5b5b5b"}).style("stroke-width",h).style("fill",g),n.append("svg:text").attr("fill","#333333").attr("class","tree-label"+(C.labels?"":" hide")).attr("dy",21).attr("text-anchor","middle").attr("text-orig",i).text(function(a){return j(i(a),C.labelLength)}).style("fill-opacity",1e-6);var o=k.transition().duration(b).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});o.select("rect").attr("width",function(){var a=r.max([N,N]);return a}).attr("height",O).style("stroke-width",h).style("fill",g),o.select("text").style("fill-opacity",1);var p=k.exit().transition().duration(b).attr("transform",function(){return"translate("+a.x+","+a.y+")"}).remove();p.select("rect").attr("width",1e-6).attr("height",1e-6),p.select("text").style("fill-opacity",1e-6);var q=x.selectAll("path.link").data(v.links(c),function(a){return a.target.id});q.enter().insert("svg:path","g").attr("class","link").attr("node-id",function(a){return a.target.id}).attr("d",function(){var b={x:a.x0,y:a.y0};return w({source:b,target:b})}).transition().duration(b).attr("d",w).style("stroke-width",function(a){return y(a.target.n)}).style("stroke",R),q.transition().duration(b).attr("d",w).style("stroke-width",function(a){return y(a.target.n)}).style("stroke",R),q.exit().transition().duration(b).attr("d",function(){var b={x:a.x,y:a.y};return w({source:b,target:b})}).remove(),c.forEach(function(a){a.x0=a.x,a.y0=a.y})}function e(a){r.select("#body").selectAll(".link").style("stroke","lightgray"),r.select("#path").html(function(){return window.tmpl("pred-path",{variable:s.legend.depVars.name})});var b=r.select("#pred-path-list");b.html("");var c=[];c.push({pred:a.yval,label:a.label,shape:"leaf"===a.type?"square":"circle",color:g(a)});for(var d=[a.id],e=v.nodes([a])[0][0];;){var f=e.parent;if(!f)break;d.push(f.id),e=f,c.push({label:e.label,shape:"leaf"===e.type?"square":"circle",color:g(e)})}c=c.reverse(),c.forEach(function(a,d){a.label=c[d+1]?c[d+1].label:"Prediction: "+a.pred,TPL='<div class="shape '+a.shape+'" style="background-color:'+a.color+'">'+'<div class="split-info">'+a.label+"</div>"+"</div>",b.append("li").html(TPL)});var h=r.select("#body").selectAll(".link")[0];h.forEach(function(a){for(var b=parseInt(a.getAttribute("node-id"),10),c=0;c<d.length;c++)if(d[c]===b){r.select(a).style("stroke","#333");break}})}function f(a){a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null)}function g(a){var b=a.yval;return"class"===s.method&&"leaf"===a.type&&(b=0,s.legend.depVars.levels.forEach(function(c,d){c===a.yval&&(b=d)})),C.colors?"leaf"===a.type?t(b):A[a.splitVar]:"#ffffff"}function h(a){var b="class"===s.method?a.loss:a.deviance;return C.borders?u(b):1}function i(a){var b="leaf"===a.type?a.yval:"multiple"===a.splitVal?"":a.splitVal;return""===b||isNaN(b)?b:r.round(b,2)}function j(a,b){return b=b||"*",a+="",isNaN(b)||b>=a.length?a:a.substring(0,b)}function k(){function a(){return"lightgray"}return a}function l(a){function b(a){a&&a.children&&(a.children.forEach(b),f(a))}b(a)}function m(a){function b(a){a&&a._children&&(a._children.forEach(b),f(a))}b(a)}function n(a,b){this.o=a,this.fn=b,o.apply(this,arguments),this.bindUI(),this.renderUI()}function o(a){if(document.all&&!document.addEventListener)throw{name:"Browser not supported",message:"RevoTreeView is only compatible with Internet Explorer 9 and above. If you are using Internet Explorer 9 then you must be in Standards Mode. We recommend you use Google Chrome for the best User Experience.",toString:function(){return this.name+": "+this.message}};c(a.data,a.palette)}function p(a,b){return new n(a,b)}var q=window,r=q.d3||{};!function(){var a={};window.tmpl=function b(c,d){c=a[c]=a[c]||document.getElementById(c).innerHTML;var e=/\W/.test(c)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+c.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):a[c]=a[c]||b(document.getElementById(c).innerHTML);return d?e(d):e}}(),r.helper={},r.helper.tooltip=function(a){function b(){var a=630,b=460;document.body&&document.body.offsetWidth&&(a=document.body.offsetWidth,b=document.body.offsetHeight),"CSS1Compat"==document.compatMode&&document.documentElement&&document.documentElement.offsetWidth&&(a=document.documentElement.offsetWidth,b=document.documentElement.offsetHeight),window.innerWidth&&window.innerHeight&&(a=window.innerWidth,b=window.innerHeight);var c=15;return{w:a-c,h:b}}function c(c){c.on("mouseover.tooltip",function(c){if(!B){e(c),r.select("body").selectAll("div.tooltip").remove(),d=r.select("body").append("div"),d.attr(f),d.style(h);var g=c.method,i=200,j=i+25,k=c.x,l="sw",m="s";c.x+j>b().w&&(k=c.x-i,l="se"),g&&(l="nw",top=c.y+105,m="n"),d.style({left:k+"px",top:top,position:"absolute","z-index":1001}),d.html(function(){var b=window.tmpl("class"===a?"classification-tip":"regression-tip",{pD:{pos:l,arrow:m,label:c.label,n:c.n,deviance:c.deviance,loss:c.loss,yval:c.yval,type:c.type,splitVar:c.splitVar}});return b})}}).on("mousemove.tooltip",function(c){if(!B&&d){var e=c.method,f=200,g=f+25,h=c.x,i=c.y-50,j="sw",k="s";if(c.x+g>b().w&&(h=c.x-f,j="se"),e&&(j="nw",i=c.y+105,k="n"),d.style({left:h+"px",top:i+"px",position:"absolute","z-index":1001}),d.html(function(){var b=window.tmpl("class"===a?"classification-tip":"regression-tip",{pD:{pos:j,arrow:k,label:c.label,n:c.n,deviance:c.deviance,loss:c.loss,yval:c.yval,type:c.type,splitVar:c.splitVar}});return b}),"class"===a){var l=190,m=33,n=1,o=c.prob,p=r.scale.linear().domain([0,r.max(o)]).range([0,m]),q=r.select("#surface").append("svg").attr("width",l).attr("height",m);q.selectAll("rect").data(o).enter().append("rect").attr("fill",function(a,b){return t(b)}).attr("x",function(a,b){return b*(l/o.length)}).attr("y",function(a){return m-p(a)}).attr("width",function(){return l/o.length-n}).attr("height",p)}}}).on("mouseout.tooltip",function(){d&&d.remove()})}var d;r.select("body").node();var f={},g="",h={};return c.attr=function(a){return arguments.length?(f=a,this):f},c.style=function(a){return arguments.length?(h=a,this):h},c.text=function(a){return arguments.length?(g=r.functor(a),this):g},c},a.palette={range:["#F7F0F9","#BB80C1"],colors:["#8ED3C6","#FFFFA8","#BDBBDD","#FB816E","#80B0D7","#FDB550","#B4DE51","#F8CCE7","#D9D9D9","#CBEAC0","#FFEE53"]},a.prototype.channels=function(){var b={},c=0;return this.options.rule.indVars.forEach(function(d){c=c>a.palette.colors.length-1?0:c,b[d]=a.palette.colors[c],c++}),b},a.prototype.render=function(){if(this.variables(),"class"===this.options.method){var a=r.select("#dep-legend ul"),b=this.options.rule.depVars.levels;b.forEach(function(b,c){var d=t(c);a.append("li").html(function(){return'<div class="shape square" style="background-color:'+d+'"><div class="split-info">'+b+"</div></div>"})})}else this.gradient()},a.prototype.variables=function(){var b=this.options,c=this.channels(),d=this.options.method;r.select("#legend").html(function(){return window.tmpl("class"===d?"classification-legend":"regression-legend",{legend:b,range:a.palette.range})});var e=r.select("#legend-vars");for(var f in c){var g=c[f];e.append("li").html(function(){return'<div class="shape circle" style="background-color:'+g+'"><div class="split-info">'+f+"</div></div>"})}},a.prototype.gradient=function(){function b(b,c){var f=c,g=2*Math.PI/d,h=g*f+g/2,i=h+Math.PI,j=50*Math.cos(h)+50,k=50*Math.cos(i)+50,l=50*Math.sin(h)+50,m=50*Math.sin(i)+50,n=e.append("svg:linearGradient").attr("id",b+f).attr("x1",j+"%").attr("y1",l+"%").attr("x2",k+"%").attr("y2",m+"%");return n.append("svg:stop").attr("offset","0%").attr("stop-color",a.palette.range[1]).attr("stop-opacity",.9),n.append("svg:stop").attr("offset","100%").attr("stop-color",a.palette.range[0]).attr("stop-opacity",.9),n}var c=r.select("#gradient").append("svg:svg");c.attr("width","180"),c.append("rect");var d=360;r.range(d);var e=c.append("defs");r.range(d).forEach(function(a,c){b("grad",c)}),c.append("rect").attr("width","158").attr("height","25").attr("fill","url(#grad0)")};var s,t,u,v,w,x,y,z,A={},B=!1,C={labels:!0,borders:!1,legend:!0,colors:!0,path:!1,labelLength:"",area:!0},D=function(a){a=a||$("#tree"),container=a.parent(),width=container.width()-(r.select("#legend-container").classed("hide")?0:200),a.attr("width",width),a.attr("height",$(window).height()),v.size([width,width]),this.resizeTO&&clearTimeout(this.resizeTO),this.resizeTO=setTimeout(function(){d(s)},500)},E=function(){C.labels=!C.labels,r.select("#body").selectAll(".tree-label").classed("hide",!C.labels)},F=function(){C.borders=!C.borders,r.select("#body").selectAll(".tree-node").style("stroke-width",function(a){return h(a)})},G=function(){C.colors=!C.colors,e(s),r.select("#body").selectAll(".tree-node").style("fill",function(a){var b=$("#3");return b.prop("disabled",!C.colors),b.prop("checked")&&!C.colors?($("#4").prop("checked",!0),H("path","legend")):b.prop("checked")&&C.colors&&r.select("#legend").classed("hide",!1),g(a)})},H=function(a,b){C[a]=!C[a],C[b]=!C[a],r.select("#legend").classed("hide",!C.legend),r.select("#path").classed("hide",!C.path)},I=function(){$("#3").prop("disabled",C.area),$("#4").prop("disabled",C.area),C.colors||$("#3").prop("disabled",!0),r.select("#legend-container").classed("hide",C.area),C.area=!C.area,D()},J=[20,120,20,120],K=1880-J[1]-J[3],L=1580-J[0]-J[2],M=0,N=35,O=35,P=20,Q=1.5,R="lightgray",S=1,T=15;return n.prototype={bindUI:function(){$("input").prop("checked",!0).prop("disabled",!1),$("#1").prop("checked",!1),$("#3").prop("checked",!0),$("#layers-dropdown").on("click",function(a){switch(a.stopPropagation(),a.target.id){case"0":E();break;case"1":F();break;case"2":G();break;case"3":C.legend||H("legend","path");break;case"4":C.path||H("path","legend");break;case"5":I()}}),$("#legth").val(""),r.select("#label-length").on("keyup",function(){C.labelLength=parseInt(this.value,10),this.upInterval&&clearTimeout(this.upInterval),this.upInterval=setTimeout(function(){b()},500)});var a=$("#"+this.o.id);$(window).on("resize",function(){D(a)}).trigger("resize")},renderUI:function(){},destroy:function(){}},p});